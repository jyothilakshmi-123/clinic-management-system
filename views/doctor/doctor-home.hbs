<header>

    <nav class="navbar navbar-expand-lg navbar-light bg-white ">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo01"
            aria-controls="navbarTogglerDemo01" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarTogglerDemo01">
            {{!-- <a class="navbar-brand  font-weight-bold text-white bg-success" data-toggle="tab" href="#">Doctor</a>
            --}}
            <div class="container-fluid">
                <ul class="nav nav-tabs nav-justified  ">
                    <li class="nav-item mr-1 active ">
                        <a href="doctor/doctor-home" class="nav-link bg-info text-white tablinks"
                            onclick="doctor(event,'Bookings')" id="defaultOpen" data-toggle="tab">Bookings</a>
                    </li>
                    <li class="nav-item mr-1  active ">

                        <a href="doctor/doctor-home" class="nav-link bg-info text-white tablinks "
                            onclick="doctor(event,'Appointments')" data-toggle="tab">Appointments</a>
                    </li>

                    <li class="nav-item mr-1 active ">
                        <a href="doctor/doctor-home" class="nav-link bg-info text-white tablinks"
                            onclick="doctor(event,'MyPatients')" data-toggle="tab">My Patients</a>
                    </li>
                    <li class="nav-item mr-1 active">
                        <a href="doctor/doctor-home" class="nav-link bg-info text-white tablinks"
                            onclick="doctor(event,'Results')" data-toggle="tab">Results</a>
                    </li>
                </ul>
            </div>
            {{!-- <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
                <li class="nav-item active">
                    <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Link</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link disabled" href="#">Disabled</a>
                </li>
            </ul> --}}
            <div class="dropdown ml-auto  ">
                <button class="btn btn-secondary dropdown-toggle mr-5 " type="button" id="dropdownMenuButton"
                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">

                    {{#if doctor}}
                    {{doctor.Doctor_Name}}

                    {{/if}}

                </button>
                <div class="dropdown-menu " aria-labelledby="dropdownMenuButton">
                    <a class="dropdown-item" href="#">My Profile</a>
                    {{#if doctor}}
                    <a class="dropdown-item" href="/doctor/logout">Logout</a>
                    {{else}}
                    <a class="dropdown-item " href="/doctor">Login</a>
                    {{/if}}



                </div>
            </div>
        </div>
    </nav>

</header>
<section>
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="modal fade" id="consult-form">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close mr-auto" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>

                            </div>
                            <div class="modal-body  ">
                                <h3 class="text-center">Consulting Patient...</h3>
                                {{#each todaysConfirmedAppointments }}
                                <form action="/doctor/consulted" method="POST">
                                    <div class="container border p-5">
                                        <div class="row ">
                                            <div class="col">
                                                <label for="comment">Name</label>
                                                <input type="text" class="form-control" name="displayName"
                                                    value="{{this.displayName}}">
                                            </div>
                                            <div class="col">
                                                <label for="comment">Age</label>
                                                <input type="number" class="form-control" name="userAge"
                                                    value="{{this.userAge}}">
                                            </div>

                                        </div>
                                        <div class="row mt-5 ">
                                            <div class="col">
                                                <label for="comment">Phone</label>
                                                <input type="text" class="form-control" name="userMobile"
                                                    value="{{this.userMobile}}">
                                            </div>
                                            <div class="col">
                                                <label for="comment">Gender</label>
                                                <input type="text" class="form-control" name="userGender"
                                                    value="{{this.userGender}}">
                                            </div>

                                        </div>
                                        <div class="row mt-5">
                                            <div class="col">

                                                <label for="comment">Prescription</label>
                                                <div class="form-group">
                                                    <select class="mul-select" name="userPrescription"
                                                        style="width: 100%;" multiple="true">
                                                        <option value="Acetaminophen">Acetaminophen</option>
                                                        <option value="Adderall">Adderall</option>
                                                        <option value="Amitriptyline">Amitriptyline</option>
                                                        <option value="Amoxicillin">Amoxicillin</option>
                                                        <option value="Ativan">Ativan</option>
                                                        <option value="Atorvastatin">Atorvastatin</option>
                                                        <option value="Azithromycin">Azithromycin</option>
                                                    </select>
                                                </div>


                                            </div>

                                        </div>
                                        <textarea name="userNotes" placeholder=" Prescription Notes"
                                            style="width: 100%;" id="userNotes" cols="10" rows="5"></textarea>
                                        <input type="hidden" id="drId" name="drId" value="{{this.dr_id}}">
                                        <input type="hidden" id="Doctor_Name" name="Doctor_Name"
                                            value="{{this.Doctor_Name}}">
                                        <input type="hidden" id="Doctor_Speciality" name="Doctor_Speciality"
                                            value="{{this.Doctor_Speciality}}">
                                        <input type="hidden" id="userId" name="userId" value="{{this.user_id}}">
                                        <input type="hidden" id="appointmentId" name="appointmentId"
                                            value="{{this._id}}">
                                        <input type="hidden" id="dateOfBooking" name="dateOfBooking"
                                            value="{{this.dateOfBooking}}">
                                        <input type="hidden" id="timeOfBooking" name="timeOfBooking"
                                            value="{{this.timeOfBooking}}">


                                        <div class="row mt-4 ">
                                            <button class="ml-auto p-2 text-white" onclick="divide()"
                                                style="border-radius: 10px; background-color: rgb(13, 13, 104);"
                                                type="submit" name="submit" value="submit"
                                                class="btn ">Consulted</button>
                                        </div>
                                    </div>
                                </form>
                                {{/each}}


                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</section>
<section>
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="modal fade" id="history">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close mr-auto" data-dismiss="modal"
                                    style="color: rgb(21, 21, 163); " aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>

                            </div>
                            <div class="modal-body  userrData">

                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</section>
<section>
    <div class="row">
        <div class="col-md-2  ml-5 mb-5 " style="padding-right: 0px; background-color: lightblue; height: 350px;">
            <div class=" row">

                <div class="personalDetails  ">
                    <ul><img style="width: 130px;
                    height: 140px;
                    border-radius: 50%;" class=" mb-3 mt-5  " src="/doctor-images/{{doctor._id}}.jpg" alt=""></ul>
                    {{!-- <ul class="pt-5 "><i class="fas fa-user fa-3x"></i></ul> --}}

                    <ul class=" pl-5 ">
                        <h4>{{doctor.Doctor_Name}}</h4>
                    </ul>
                    <p class="text-dark text-center p-1"><small>{{doctor.Doctor_Email}}</small></p>
                    <a class="ml-2 btn-info btn-block text-center" style="color: #fff; border-radius: 10px; "
                        href="/doctor/edit-doctor/{{doctor._id}}">
                        Edit Profile </a>
                </div>




                {{!-- <div class="row" style="padding-right: 0px; height: 200px; background-color: teal;">

                </div> --}}
            </div>


        </div>
        <div class="col-md-9 bg-light border p-4 ml-3 mb-5 " style=" ">

            <div class="tabcontent" id="Appointments">
                <ul class="nav nav-tabs">
                    <li class="nav-item">
                        <a href="#Today" class=" nav-link active  mr-4" role="tab" data-toggle="tab">Today</a>
                    </li>
                    <li class="nav-item">
                        <a href="#Upcoming" class="nav-link    mr-4" role="tab" data-toggle="tab">Upcoming</a>
                    </li>
                    <li class="nav-item">
                        <a href="#Consulted" class="nav-link   " role="tab" data-toggle="tab">Consulted</a>
                    </li>
                    <li class="nav-item">
                        <a href="#Cancelled" class="nav-link   " role="tab" data-toggle="tab">Cancelled</a>
                    </li>
                    <li class="nav-item">
                        <a href="#Expired" class="nav-link   " role="tab" data-toggle="tab">Expired</a>
                    </li>
                    <form class="form-inline p-3 ml-auto">
                        <input type="text" name="search1" id="search1" class="form-control" />

                    </form>
                </ul>


                <div class="tab-content">
                    <div class="tab-pane active container" role="tabpanel" id="Today">
                        <div class="col-md-12">
                            <table class="table mt-4  border p-3 mb-5">
                                <thead>
                                    <tr>
                                        <th scope="col">Patient Name</th>
                                        <th scope="col">Appointment Date</th>
                                        <th scope="col">Mobile Number</th>

                                        {{!-- <th scope="col">Price</th> --}}
                                        <th scope="col">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{#each todaysConfirmedAppointments }}
                                    <tr>
                                        {{!-- <th scope="row">3</th> --}}

                                        <td><img class="mr-2" style="width: 50px; height: 50px "
                                                src="/user-images/{{this.user_id}}.jpg" alt="">{{this.displayName}}</td>
                                        <td>{{this.dateOfBooking}}</td>
                                        <td>{{this.userMobile}}</td>

                                        <td><a href="" style="color: green;" data-toggle="modal"
                                                data-target="#consult-form">Consult</a>
                                            <a href="" style="color: green;" class="ml-2"
                                                onclick="appointmentCancel('{{this._id}}')">Reject</a>
                                        </td>


                                        {{!-- <td><a href="/doctor/consult-form"
                                                style="color: rgb(79, 228, 79);">Consult</a>
                                        </td>
                                        <td> --}}


                                    </tr>
                                    {{/each}}
                                </tbody>
                            </table>
                        </div>


                    </div>
                    <div class="tab-pane " role="tabpanel" id="Upcoming">
                        <table class="table mt-4  border p-3 mb-5">
                            <thead>
                                <tr>
                                    <th scope="col">Patient Name</th>
                                    <th scope="col">Appointment Date</th>
                                    <th scope="col">Mobile Number</th>

                                    {{!-- <th scope="col">Price</th> --}}
                                    <th scope="col">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each upcomingConfirmedAppointments }}
                                <tr>
                                    {{!-- <th scope="row">3</th> --}}

                                    <td><img class="mr-2" style="width: 50px; height: 50px "
                                            src="/user-images/{{this.user_id}}.jpg" alt="">{{this.displayName}}</td>
                                    <td>{{this.dateOfBooking}}</td>
                                    <td>{{this.userMobile}}</td>

                                    <td><a href="" style="color: green;" data-toggle="modal"
                                            data-target="#consult-form">Consult</a>
                                        <a href="" style="color: green;" class="ml-2"
                                            onclick="appointmentCancel('{{this._id}}')">Reject</a>
                                    </td>


                                    {{!-- <td><a href="/doctor/consult-form"
                                            style="color: rgb(79, 228, 79);">Consult</a>
                                    </td>
                                    <td> --}}


                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>
                    <div class="tab-pane " role="tabpanel" id="Consulted">
                        <table class="table mt-4  border p-3 mb-5">
                            <thead>
                                <tr>
                                    <th scope="col">Patient Name</th>
                                    <th scope="col">Appointment Date</th>
                                    <th scope="col">Mobile Number</th>

                                    {{!-- <th scope="col">Price</th> --}}
                                    <th scope="col">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each consultedAppointments }}
                                <tr>
                                    {{!-- <th scope="row">3</th> --}}

                                    <td><img class="mr-2" style="width: 50px; height: 50px "
                                            src="/user-images/{{this.user_id}}.jpg" alt="">{{this.displayName}}</td>
                                    <td>{{this.dateOfBooking}}</td>
                                    <td>{{this.userMobile}}</td>


                                    {{!-- <td><a href="" style="color: green;">{{this.Status}}</a></td> --}}
                                    <td>
                                        <p style="color: green;">{{this.Status}}</p>
                                    </td>



                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>

                    <div class="tab-pane  container" role="tabpanel" id="Cancelled">
                        <div class="col-md-12">
                            <table class="table mt-4  border p-3 mb-5">
                                <thead>
                                    <tr>
                                        <th scope="col">Patient Name</th>
                                        <th scope="col">Appointment Date</th>
                                        <th scope="col">Mobile Number</th>

                                        {{!-- <th scope="col">Price</th> --}}
                                        <th scope="col">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{#each cancelledAppointments }}
                                    <tr>
                                        {{!-- <th scope="row">3</th> --}}

                                        <td><img class="mr-2" style="width: 50px; height: 50px "
                                                src="/user-images/{{this.user_id}}.jpg" alt="">{{this.displayName}}</td>
                                        <td>{{this.dateOfBooking}}</td>
                                        <td>{{this.userMobile}}</td>


                                        <td>
                                            <p style="color: green;">Cancelled</p>
                                        </td>


                                        {{!-- <td><a href="/doctor/consult-form"
                                                style="color: rgb(79, 228, 79);">Consult</a>
                                        </td>
                                        <td> --}}


                                    </tr>
                                    {{/each}}
                                </tbody>
                            </table>
                        </div>


                    </div>
                    <div class="tab-pane  container" role="tabpanel" id="Expired">
                        <div class="col-md-12">
                            <table class="table mt-4  border p-3 mb-5">
                                <thead>
                                    <tr>
                                        <th scope="col">Patient Name</th>
                                        <th scope="col">Appointment Date</th>
                                        <th scope="col">Mobile Number</th>

                                        {{!-- <th scope="col">Price</th> --}}
                                        <th scope="col">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{#each expiredAppointments }}
                                    <tr>
                                        {{!-- <th scope="row">3</th> --}}

                                        <td><img class="mr-2" style="width: 50px; height: 50px "
                                                src="/user-images/{{this.user_id}}.jpg" alt="">{{this.displayName}}</td>
                                        <td>{{this.dateOfBooking}}</td>
                                        <td>{{this.userMobile}}</td>

                                        <td><a href="" style="color: green;">{{this.Status}}</a></td>


                                        {{!-- <td><a href="/doctor/consult-form"
                                                style="color: rgb(79, 228, 79);">Consult</a>
                                        </td>
                                        <td> --}}


                                    </tr>
                                    {{/each}}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>



            </div>






            <div class="tabcontent" id="Bookings">
                <form class="form-inline p-3 ml-auto">
                    <input type="text" name="search2" id="search2" class="form-control ml-auto" />

                </form>
                <table class="table mt-4  border p-3 mb-5">
                    <thead>
                        <tr>
                            <th scope="col">Patient Name</th>
                            <th scope="col">Appointment Date</th>
                            <th scope="col">Mobile Number</th>

                            {{!-- <th scope="col">Price</th> --}}
                            <th scope="col">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each pendingAppointments }}
                        <tr>
                            {{!-- <th scope="row">3</th> --}}

                            <td><img class="mr-2" style="width: 50px; height: 50px "
                                    src="/user-images/{{this.user_id}}.jpg" alt="">{{this.displayName}}</td>
                            <td>{{this.dateOfBooking}}</td>
                            <td>{{this.userMobile}}</td>

                            <td><a href="" style="color: green;" class="mr-3"
                                    onclick="appointmentConfirm('{{this._id}}')">Accept</a>
                                <a href="" style="color: green;" onclick="appointmentCancel('{{this._id}}')">Reject</a>
                            </td>


                            {{!-- <td><a href="/doctor/consult-form" style="color: rgb(79, 228, 79);">Consult</a>
                            </td>
                            <td> --}}


                        </tr>
                        {{/each}}
                    </tbody>
                </table>

            </div>
            <div class="tabcontent" id="MyPatients">
                <div class="row">

                    {{#each myPatients}}
                    <div class="col-md-4 ">
                        <div class="card border-info  mb-3 mt-4  " style="border-radius: 10px; width:max-content;">
                            <div class="card-header ">
                                <img class=" float-left rounded-circle  border card-image mr-3"
                                    style="height: 80px; width: 80px;" src="/user-images/{{this.user_id}}.jpg" alt="">
                                <div class="float-right">
                                    <h3 class=" ">{{this.displayName}}</h3>
                                    <small class="mr-2">Age:{{this.userAge}}</small>
                                    <small>Gender:{{this.userGender}}</small><br>
                                    <small>Phone:{{this.userMobile}}</small>
                                </div>

                            </div>
                            <div class="card-body ">

                                <p>Appointment Date : {{this.dateOfBooking}}</p>
                                <p>Appointment Time : {{this.timeOfBooking}}</p>
                                <p>Booking For : {{this.Doctor_Name}}</p>
                                {{!-- <button type="button" class="  mt-3 mb-3 p-2"
                                    style="background-color:  #3efc8a; color: white;  border-radius: 30px; border: 1px;">Make
                                    an Appointment</button> --}}
                            </div>





                        </div>
                    </div>
                    {{/each}}
                </div>

            </div>
            <div class="tabcontent" id="Results">
                <div class="mb-3  row">

                    <button class="excel-export ml-auto mr-5" style="color: green;"
                        onclick="excelExport('{{doctor._id}}')">
                        Create Excelsheet
                    </button>
                </div>
                <div class="row">


                    {{#each prescriptions}}
                    <div class="col-md-4 ">
                        <div class="card border-info  mb-3 mt-4  " style="border-radius: 10px; width:max-content;">
                            <div class="card-header ">
                                <img class=" float-left rounded-circle  border card-image mr-3"
                                    style="height: 80px; width: 80px;" src="/user-images/{{this.userId}}.jpg">
                                <div class="float-right">
                                    <h3 class=" ">{{this.displayName}}</h3>

                                    <small class="">Age:{{this.userAge}}</small><br>
                                    <small>Gender:{{this.userGender}}</small><br>
                                    <small>Phone:{{this.userMobile}}</small>
                                </div>

                            </div>
                            <div class="card-body ">
                                <p> <strong>Date of Appointment :</strong> {{dateOfBooking}}</p>
                                <p><strong>Time of Appointment :</strong>{{timeOfBooking}}</p>
                                <strong> Medicines :</strong>
                                {{#each this.userPrescription}}
                                <li class="ml-5">{{this}}</li>
                                {{/each}}
                                <p><strong>Notes :</strong>{{this.userNotes}}</p>
                                <div class="btn-info btn-block text-center p-1"
                                    style="color: #fff; border-radius: 10px; background-color: rgb(20, 20, 105);"
                                    data-toggle="modal" data-target="#history"
                                    onclick="showHistory('{{this.userId}}','{{this.drId}}')" alt="">History of Patient
                                </div>
                            </div>

                        </div>
                    </div>
                    {{/each}}
                </div>

            </div>
        </div>


    </div>
</section>
<script>
    window.onload = function () {
        startTab();
    };

    function startTab() {
        document.getElementById("defaultOpen").click();

    }

    function doctor(evt, evtName) {
        // Declare all variables
        var i, tabcontent, tablinks;

        // Get all elements with class="tabcontent" and hide them
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }

        // Get all elements with class="tablinks" and remove the class "active"
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        // Show the current tab, and add an "active" class to the button that opened the tab
        document.getElementById(evtName).style.display = "block";
        evt.currentTarget.className += " active";
    }

</script>

<script>
    $(document).ready(function () {
        $(".mul-select").select2({
            placeholder: "medicine", //placeholder
            tags: true,
            tokenSeparators: ['/', ',', ';', " "]
        });
    })
</script>
<script>
    {{!-- const EXCEL_TYPE = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8';
    const EXCEL_EXTENSION = '.xlsx'; --}}
    function excelExport(drId) {

        $.ajax({
            url: '/doctor/export-to-excel',
            data: {
                dr: drId,
            },

            method: 'post',
            success: (response) => {
                console.log("Called ajax to export excel and recived success response...Creaing excel sheet..")

                let el;
                for (el = 0; el < response.length; el++) {
                    const arrayItem = response[el];
                    const userPrescription = arrayItem.userPrescription
                    //var curr = arrayItem;
                    let ind;
                    for (ind = 0; ind < userPrescription.length; ind++) {
                        var key = "presecrption " + (ind + 1);
                        response[el][key] = userPrescription[ind]
                    }
                    delete response[el]["userPrescription"];
                    delete response[el]["_id"];
                    delete response[el]["drId"];
                    delete response[el]["Doctor_Name"];
                    delete response[el]["appointmentId"];
                    delete response[el]["userId"];
                    delete response[el]["submit"];
                }


                const worksheet = XLSX.utils.json_to_sheet(response);
                const workbook = {
                    Sheets: {
                        'response': worksheet
                    },
                    SheetNames: ['response']
                }
                const excelBuffer = XLSX.write(workbook, { booktype: 'xlsx', type: 'array' })
                console.log(excelBuffer)
                saveAsExcel(excelBuffer, 'myFile')

            }
        })

    }
    function saveAsExcel(buffer, filename) {
        const data = new Blob([buffer], { type: EXCEL_TYPE });
        saveAs(data, filename + '_export_' + new Date().getTime() + EXCEL_EXTENSION)
    }
    var _global = typeof window === 'object' && window.window === window
        ? window : typeof self === 'object' && self.self === self
            ? self : typeof global === 'object' && global.global === global
                ? global
                : this

    function bom(blob, opts) {
        if (typeof opts === 'undefined') opts = { autoBom: false }
        else if (typeof opts !== 'object') {
            console.warn('Deprecated: Expected third argument to be a object')
            opts = { autoBom: !opts }
        }

        // prepend BOM for UTF-8 XML and text/* types (including HTML)
        // note: your browser will automatically convert UTF-16 U+FEFF to EF BB BF
        if (opts.autoBom && /^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(blob.type)) {
            return new Blob([String.fromCharCode(0xFEFF), blob], { type: blob.type })
        }
        return blob
    }

    function download(url, name, opts) {
        var xhr = new XMLHttpRequest()
        xhr.open('GET', url)
        xhr.responseType = 'blob'
        xhr.onload = function () {
            saveAs(xhr.response, name, opts)
        }
        xhr.onerror = function () {
            console.error('could not download file')
        }
        xhr.send()
    }

    function corsEnabled(url) {
        var xhr = new XMLHttpRequest()
        // use sync to avoid popup blocker
        xhr.open('HEAD', url, false)
        try {
            xhr.send()
        } catch (e) { }
        return xhr.status >= 200 && xhr.status <= 299
    }

    // `a.click()` doesn't work for all browsers (#465)
    function click(node) {
        try {
            node.dispatchEvent(new MouseEvent('click'))
        } catch (e) {
            var evt = document.createEvent('MouseEvents')
            evt.initMouseEvent('click', true, true, window, 0, 0, 0, 80,
                20, false, false, false, false, 0, null)
            node.dispatchEvent(evt)
        }
    }

    // Detect WebView inside a native macOS app by ruling out all browsers
    // We just need to check for 'Safari' because all other browsers (besides Firefox) include that too
    // https://www.whatismybrowser.com/guides/the-latest-user-agent/macos
    var isMacOSWebView = _global.navigator && /Macintosh/.test(navigator.userAgent) && /AppleWebKit/.test(navigator.userAgent) && !/Safari/.test(navigator.userAgent)

    var saveAs = _global.saveAs || (
        // probably in some web worker
        (typeof window !== 'object' || window !== _global)
            ? function saveAs() { /* noop */ }

            // Use download attribute first if possible (#193 Lumia mobile) unless this is a macOS WebView
            : ('download' in HTMLAnchorElement.prototype && !isMacOSWebView)
                ? function saveAs(blob, name, opts) {
                    var URL = _global.URL || _global.webkitURL
                    var a = document.createElement('a')
                    name = name || blob.name || 'download'

                    a.download = name
                    a.rel = 'noopener' // tabnabbing

                    // TODO: detect chrome extensions & packaged apps
                    // a.target = '_blank'

                    if (typeof blob === 'string') {
                        // Support regular links
                        a.href = blob
                        if (a.origin !== location.origin) {
                            corsEnabled(a.href)
                                ? download(blob, name, opts)
                                : click(a, a.target = '_blank')
                        } else {
                            click(a)
                        }
                    } else {
                        // Support blobs
                        a.href = URL.createObjectURL(blob)
                        setTimeout(function () { URL.revokeObjectURL(a.href) }, 4E4) // 40s
                        setTimeout(function () { click(a) }, 0)
                    }
                }

                // Use msSaveOrOpenBlob as a second approach
                : 'msSaveOrOpenBlob' in navigator
                    ? function saveAs(blob, name, opts) {
                        name = name || blob.name || 'download'

                        if (typeof blob === 'string') {
                            if (corsEnabled(blob)) {
                                download(blob, name, opts)
                            } else {
                                var a = document.createElement('a')
                                a.href = blob
                                a.target = '_blank'
                                setTimeout(function () { click(a) })
                            }
                        } else {
                            navigator.msSaveOrOpenBlob(bom(blob, opts), name)
                        }
                    }

                    // Fallback to using FileReader and a popup
                    : function saveAs(blob, name, opts, popup) {
                        // Open a popup immediately do go around popup blocker
                        // Mostly only available on user interaction and the fileReader is async so...
                        popup = popup || open('', '_blank')
                        if (popup) {
                            popup.document.title =
                                popup.document.body.innerText = 'downloading...'
                        }

                        if (typeof blob === 'string') return download(blob, name, opts)

                        var force = blob.type === 'application/octet-stream'
                        var isSafari = /constructor/i.test(_global.HTMLElement) || _global.safari
                        var isChromeIOS = /CriOS\/[\d]+/.test(navigator.userAgent)

                        if ((isChromeIOS || (force && isSafari) || isMacOSWebView) && typeof FileReader !== 'undefined') {
                            // Safari doesn't allow downloading of blob URLs
                            var reader = new FileReader()
                            reader.onloadend = function () {
                                var url = reader.result
                                url = isChromeIOS ? url : url.replace(/^data:[^;]*;/, 'data:attachment/file;')
                                if (popup) popup.location.href = url
                                else location = url
                                popup = null // reverse-tabnabbing #460
                            }
                            reader.readAsDataURL(blob)
                        } else {
                            var URL = _global.URL || _global.webkitURL
                            var url = URL.createObjectURL(blob)
                            if (popup) popup.location = url
                            else location.href = url
                            popup = null // reverse-tabnabbing #460
                            setTimeout(function () { URL.revokeObjectURL(url) }, 4E4) // 40s
                        }
                    }
    )

    _global.saveAs = saveAs.saveAs = saveAs

    if (typeof module !== 'undefined') {
        module.exports = saveAs;
    }
</script>